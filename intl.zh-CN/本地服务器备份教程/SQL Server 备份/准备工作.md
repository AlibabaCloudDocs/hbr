# 准备工作

您可以使用混合云服务（HBR）备份部署在本地数据中心的SQL Server数据库，本文主要为您介绍备份前的准备工作。

## 注意事项

使用混合云服务（HBR）备份部署在本地数据中心的SQL Server数据库时，请注意以下事项：

-   确保安装.NET Framework 4.5及以上版本。
-   混合云备份服务支持备份的SQL Server版本包括：SQL Server 2008R2、SQL Server 2012、SQL Server 2014、SQL Server 2016、SQL Server 2017。详情请参见[使用限制](/intl.zh-CN/产品简介/使用限制.md)。
-   如果您需要备份部署在ECS中的SQL Server，请参见[备份部署在ECS中的SQL Server](/intl.zh-CN/ECS备份教程/SQL Server备份/概述.md)。
-   SQL Server数据库不支持数据库文件位于启用了压缩功能的文件系统上，更多数据库安装限制请参见[SQL Server的默认实例和命名实例的文件位置](https://docs.microsoft.com/en-us/sql/sql-server/install/file-locations-for-default-and-named-instances-of-sql-server?view=sql-server-2017)。

## （推荐）使用RAM用户AccessKey

RAM是阿里云提供的用户身份管理与资源访问控制服务。RAM允许在一个云账号下创建并管理多个身份，并允许给单个身份或一组身份分配不同的权限，从而实现不同用户拥有不同资源访问权限的目的。

激活备份客户端需要AccessKey信息，由于主账号AccessKey泄露会威胁您所有资源的安全，强烈建议您使用RAM用户AccessKey进行操作。备份前确保您已经[创建RAM用户](/intl.zh-CN/用户管理/创建RAM用户.md)，并[为RAM用户创建访问密钥](/intl.zh-CN/安全设置/访问密钥/为RAM用户创建访问密钥.md)。

## 步骤1：注册SQL Server实例

注册SQL Server实例后，混合云备份服务可以在SQL Server的节点中下载、安装文件客户端。文件客户端可以帮助您进行备份和恢复任务。具体操作如下：

1.  登录[混合云备份管理控制台](https://hbr.console.aliyun.com)。

2.  在页面上方，选择希望存放备份数据的地域。

3.  在左侧导航栏，选择**备份** \> **本地服务器备份** \> **SQL Server**。

4.  在SQL Server实例页签右上角，单击**注册SQL Server实例**。

5.  在注册SQL Server实例页面，按照以下步骤进行操作。

    -   创建实例
        1.  配置以下参数创建实例：

            |参数|说明|
            |:-|:-|
            |备份库名称|备份库是混合云备份的云上存储仓库，用于保存备份的数据。多个客户端可以备份到同一个备份库。备份库有地域属性，您仅能选择或者新建当前地域下的备份库。             -   如果您之前已经创建过备份库，单击**选择备份库**，并在**备份库名称**下拉框中选择已创建的备份库。
            -   如果您之前没有创建过备份库，单击**新建备份库**，然后输入**备份库名称**即可创建一个新仓库。备份库名称不得超过64个字节。 |
            |服务器名称|SQL Server服务器名称及实例名称，格式为：<服务器名\>\\<实例名\>。例如：localhost\\MSSQLSERVER。默认实例可不填写实例名称。|
            |认证方式|选择连接SQL Server的认证方式。             -   如果您选择了Windows用户认证方式，则需要输入连接SQL Server的Windows用户名。
            -   如果您选择了SQL Server认证方式，则需要输入连接SQL Server的SQL Server用户名。 |
            |密码|根据您选择的认证方式，输入连接SQL Server的密码。|

        2.  单击**下一步**。
    -   添加客户端
        1.  配置以下参数添加客户端：

            |参数|描述|
            |--|--|
            |客户端来源|            -   **新建客户端**：如果您在此服务器没安装、激活过文件客户端，选择此项。
            -   **选择已激活客户端**：如果此服务器已安装激活过文件客户端，选择此项，并选择一个安装激活过的客户端。 |
            |客户端名称|为此客户端命名。名称不得超过64个字节。|
            |软件平台|选择需要备份的机器使用的系统：             -   Window 32-bit
            -   Window 64-bit |
            |网络类型|            -   **专有网络（VPC）**：需要备份的f服务器使用阿里云专有网络（VPC），且和备份仓库在同一个地域时，选择此项。
            -   **经典网络**：无法使用专有网络的场景下选择此项。 |
            |用HTTPS传输数据|数据加密存储到备份库后，您可以选择是否使用HTTPS传输数据。使用HTTPS会降低数据传输性能。如果修改了此项配置，在下一次备份或恢复任务开始时生效。|

        2.  单击**创建**后，页面会出现**下载客户端**选项。
    -   下载、安装客户端
        1.  单击**下载客户端**。
        2.  保存下载好的客户端。
        3.  登录安装SQL Server的目标服务器安装该客户端，选择可用的安装目录。

            **说明：** 日志和执行文件都会在该目录下，确保该目录下有可用的空间。

    -   激活客户端
        1.  客户端安装成功后，需要激活客户端。返回混合云备份控制台，在添加客户端页面，单击**下一步**，然后按照以下说明填写激活客户端的所需参数。

            |参数|说明|
            |:-|:-|
            |客户端IP地址|文件客户端所在服务器或虚机的IP地址。 **说明：** 当前浏览器必须能够连接到此IP地址。 |
            |AccessKey Id|在开通HBR服务的阿里云账户中下载AccessKey ID和AccessKey Secret。详情请参见[为RAM用户创建AccessKey](/intl.zh-CN/常见问题/一般性问题/为RAM用户创建AccessKey.md)。|
            |AccessKey Secret|
            |客户端WEB登录密码|设置客户端登录密码。登录密码至少为6位。|

        2.  单击**激活客户端**。
            -   文件客户端安装激活后，您可以查看SQL Server实例中节点的备份客户端安装状态，如需删除客户端，可在客户端右侧的操作栏，单击**删除**。
            -   SQL Server实例注册完成后，在SQL Server备份页面，选择**SQL Server实例**页签，可以查看实例的注册信息及状态。在实例右侧的操作列表，单击**更多** \> **编辑实例**，修改实例的连接信息。

## 步骤2：为新节点添加客户端

SQL Server实例注册后，您可以根据集群部署的变化，为新增的节点安装备份客户端，具体操作步骤如下：

**说明：** 单个SQL Server实例仅支持添加一个备份客户端。

1.  找到目标SQL Server实例，单击实例ID，或在实例右侧的操作列表，选择**查看详情**。

2.  在SQL Server实例信息页面，单击**客户端**页签，然后在页面的右上角，单击**添加客户端**。

3.  输入所需参数，单击**创建**，然后页面会出现**下载客户端**按键。具体参数配置请参见[添加客户端](#table_pi5_94t_4mu)。

4.  如果您没有将客户端直接下载到目标节点，您需要将下载的客户端复制到目标节点中，然后安装客户端。

5.  登录混合云备份管理控制台，找到该客户端，在其右侧的操作栏，单击**激活客户端**，输入所需参数。具体参数说明请参见[添加客户端](#table_pi5_94t_4mu)。

6.  单击**激活客户端**完成新节点的客户端安装激活。


## 步骤3：创建备份数据库组

开始备份前，您需要为将备份计划相同的数据库归类到同一数据库组。

**说明：** 如果您希望为一个数据库单独进行备份，仅需为该数据库单独建组即可。

1.  登录[混合云备份管理控制台](https://hbr.console.aliyun.com)。

2.  在左侧导航栏，选择**备份** \> **本地服务器备份** \> **SQL Server**。

3.  选择**备份数据库组**页签。然后在页面右上角，单击**创建备份数据库组**。

4.  在创建备份数据库组页面，输入组名以及备注，然后选中一个或多个数据库，并添加到组中。

5.  单击**确定**。


## （推荐）配置实例内存用量

SQL Server默认使用尽可能多的系统内存，这可能影响备份的正常运行。因此建议您参照如下步骤限制实例内存用量：

1.  使用SQL Server Management Studio连接要操作的数据库实例。

2.  在左侧实例名称上右键选择**属性**。

3.  在内存页签，配置合理的**最大服务器内存**属性值。

    **说明：** 建议为备份以及系统中的其他服务预留2 GB及以上的内存空间。例如系统内存量为16 GB，推荐最大服务器内存值为14336。


