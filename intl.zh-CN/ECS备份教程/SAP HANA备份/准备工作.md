# 准备工作 {#concept_yml_bpj_ggb .task}

您可以使用混合云备份服务（HBR）来备份ECS实例中部署的SAP HANA数据库，并在需要时快速恢复。备份前您需要做以下准备工作。

## 步骤1：授权角色 {#section_a85_tb3_acj .section}

使用混合云备份服务来备份ECS文件时，需要您同意授权两个角色：AliyunHBRDefaultRole、AliyunECSAccessingHBRRole。具体步骤如下：

1.  登录[混合云备份管理控制台](https://hbr.console.aliyun.com)。
2.  选择**ECS备份** \> **ECS文件备份**。
3.  页面会依次弹出授权对话框，根据提示授权这两个角色。![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/82684/156862843137733_zh-CN.png)



## 步骤2：配置云助手 {#section_1cg_0k0_wep .section}

-   ECS备份客户端需要和阿里云云助手配合使用。2017年12月01日之后创建的ECS实例，默认预装了云助手客户端。如果需要备份的ECS实例是2017年12月01日之前购买的，需要您自行[安装云助手客户端](../../../../intl.zh-CN/运维与监控/云助手/配置云助手客户端.md)。
-   已经安装好云助手的经典网络ECS实例需要按照以下步骤配置云助手。
    -   Windows系统：
        1.  远程连接该ECS实例。然后在C:\\ProgramData\\aliyun\\assist\\目录下创建`region-id`文件，并根据ECS所在地域，在文件中写入相应的`region id`。例如，ECS实例的地域为杭州，则写入`cn-hangzhou`。

            ``` {#d8e107}
            echo cn-hangzhou >C:\ProgramData\aliyun\assist\region-id
            ```

            各地域相对应的region-id参见下表：

            |地域|region-id|
            |:-|:--------|
            |华东1（杭州）|cn-hangzhou|
            |华东2（上海）|cn-shanghai|
            |华北2（北京）|cn-beijing|
            |华南1（深圳）|cn-shenzhen|

        2.  在任务管理器重启AliyunService服务。
    -   Linux系统：
        1.  远程连接该ECS实例。在/usr/local/share/aliyun-assist/目录下创建`region-id`文件，并根据ECS所在地域，在文件中写入相应的`region id`。例如，ECS实例的地域为杭州，则写入`cn-hangzhou`。

            ``` {#d8e200}
            echo cn-hangzhou >/usr/local/share/aliyun-assist/region-id
            ```

            各地域相对应的region-id参见下表：

            |地域|region-id|
            |:-|:--------|
            |华东1（杭州）|cn-hangzhou|
            |华东2（上海）|cn-shanghai|
            |华北2（北京）|cn-beijing|
            |华南1（深圳）|cn-shenzhen|

        2.  依次运行`chkconfig agentwatch off`以及`chkconfig agentwatch on`，或直接运行`systemctl restart agentwatch`重启云助手服务。

            **说明：** 如果重启后云助手仍无法运行，请使用以上命令再次重启云助手。


## 步骤3：注册SAP HANA实例 {#section_mw5_npj_ggb .section}

注册SAP HANA实例需要配置SAP HANA连接信息，实例注册完成后会在SAP HANA的节点上安装ECS备份客户端。具体操作如下：

1.  登录[混合云备份管理控制台](https://hbr.console.aliyun.com)。
2.  选择要备份的ECS实例所在的区域。
3.  在左侧导航栏，选择**ECS备份** \> **SAP HANA备份**。
4.  在页面右上角，单击**注册SAP HANA实例**。
5.  在注册SAP HANA页面，按照以下说明配置所需信息。![](http://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/83216/156862843135970_zh-CN.png)

 

    |配置项|说明|
    |:--|:-|
    |备份仓库名称|备份仓库是混合云备份的云上存储仓库，用于保存备份的数据。多个客户端可以备份到同一个仓库。     -   如您之前已经创建过备份仓库

在下拉列表中选择希望使用的仓库即可。

    -   如您之前没有创建过备份仓库

单击**新建仓库**。然后输入**仓库名称**和**描述**即可创建一个新仓库。仓库名称不得超过64个字节。

 |
    |HANA实例别名|为需要备份的SAP HANA的实例添加一个别名。|
    |Host地址|输入SAP HANA主节点的私有或内网IP地址。|
    |实例号|输入安装SAP HANA时指定的实例编号。|
    |用户名|输入用于连接SAP HANA的用户名。|
    |密码|输入用于连接SAP HANA的密码。|
    |SSL连接|选择是否使用SSL安全连接方式连接数据库。|
    |验证SSL证书|加密数据库连接开启后，需选择是否验证数据库服务端SSL证书。|

6.  单击**下一步**。
7.  勾选要注册的SAP HANA实例的所有节点，混合云备份服务将在这些节点中安装ECS备份客户端。您可以在搜索栏左侧，选择实例ID，实例名称或VPC ID，然后输入相应的全称或关键字搜索目标ECS实例。
8.  配置完成后，单击**创建**，系统会自动在您选择的ECS实例中安装备份客户端。 

    **说明：** SAP HANA实例注册完成后，在SAP HANA备份页面，选择**SAP HANA实例**页签，可以查看实例的注册信息及状态。在实例右侧的操作列表，选择**更多** \> **编辑实例**修改实例的相关信息。


## （可选）查看并管理节点 {#section_ny2_lfr_ggb .section}

SAP HANA实例注册后，您可以查看SAP HANA实例中各个节点的备份客户端安装状态，确保需要备份的节点已经成功安装了ECS备份客户端。并使用验证节点功能，根据集群的变化，为新增的节点安装备份客户端。

-   查看节点的备份客户端安装状态

    查看需要备份的节点是否已经成功安装了ECS备份客户端，具体操作如下：

    1.  SAP HANA实例注册完成后，在SAP HANA备份页面，选择**SAP HANA实例**页签。
    2.  在目标实例右侧的操作列表，选择**更多** \> **管理节点**。
    3.  单击**节点信息**页签，查看节点的备份客户端安装状态。如成功安装，状态为已激活。您还可以做以下操作：
        -   升级客户端

            如果您需要升级某个节点的混合云备份客户端，您可以找到该节点，在客户端类型处，单击**升级**即可。

            **说明：** 升级混合云备份客户端期间需要关闭SAP HANA的备份功能，具体参见[SAP Note 2009486](https://launchpad.support.sap.com/#/notes/2009486)。

        -   重新安装

            如安装失败可以在节点右侧，选择**操作** \> **重新安装**。

        -   卸载客户端

            如需在节点上卸载客户端，您可以在节点右侧，选择**操作** \> **卸载客户端**。

        -   删除客户端

            如需删除备份节点，并卸载在该备份节点上安装的客户端，您可以在节点右侧，选择**操作** \> **删除**。

            **说明：** 删除客户端前您需要确保该客户端上没有正在进行中或已完成的备份任务。

-   验证节点

    验证节点功能可以自动发现SAP HANA集群的节点变化以及不属于集群的ECS实例，并提示为新增的节点安装ECS备份客户端，为不属于集群的ECS实例卸载ECS备份客户端。验证节点的具体操作如下：

    1.  SAP HANA实例注册完成后，在SAP HANA备份页面，选择**SAP HANA实例**页签。
    2.  在目标实例右侧的操作列表，选择**更多** \> **管理节点**。
    3.  在HANA实例信息页面右上角，单击**验证节点**。
    4.  在**验证HANA节点**页面，查看节点信息。
    5.  勾选需要安装或卸载ECS备份客户端的节点。
    6.  单击**确认执行**。
    **说明：** 

    -   您还可以在HANA实例信息页面，单击**添加节点**，选择需要安装ECS备份客户端的ECS实例，手动添加SAP HANA集群中的节点。
    -   您还可以在HANA实例信息页面，单击**数据库信息**页签，查看SAP HANA实例所有数据库的状态。

## （可选）设置数据库备份 {#section_6gq_1xm_nrk .section}

为了更好地备份SAP HANA，建议您设置Backint以及日志备份，具体参见[设置数据备份配置文件](intl.zh-CN/ECS备份教程/SAP HANA备份/设置数据备份配置文件.md)以及[设置数据库日志备份](intl.zh-CN/ECS备份教程/SAP HANA备份/设置数据库日志备份.md)。

**说明：** 您还可以开启[备份报警](intl.zh-CN/ECS备份教程/SAP HANA备份/备份报警.md)，备份报警功能可以在备份失败或客户端与服务器连接断开时，向您设置的报警联系人发邮件通知。

