# 恢复SQL Server

使用混合云备份服务（HBR）将SQL Server数据库备份到云上备份库后，您可以根据需要将备份的数据库恢复到源SQL Server实例，将备份的数据库恢复到同备份库下其他SQL Server实例，还可以将当前地域备份的数据库恢复至其他地域的SQL Server实例。

## 前提条件

已完成SQL Server备份，详情请参见[备份SQL Server](/cn.zh-CN/ECS备份教程/SQL Server备份/备份SQL Server.md)。

## 背景信息

恢复SQL Server数据库时，请注意以下事项：

-   因暂时不支持修改数据库的恢复路径，则恢复目标SQL Server数据库的位置必须与原备份SQL Server的数据库默认位置保持一致。如果恢复的目标SQL Server数据库的位置和原来的默认位置不一致，则恢复后的SQL Server数据库将无法加载。

    **说明：** SQL Server数据库的位置可从**服务器属性** \> **数据库设置** \> **数据库默认路径**中查看。

-   当备份的SQL Server数据库拥有多个.ndf文件时，只能恢复到与原数据库同名的目标数据库。当恢复的目标数据库名称和原数据库名称不一样时，则恢复失败。
-   恢复SQL Server数据库时若选择差量备份，将自动恢复全量备份。无需单独恢复全量备份后再恢复差量备份。
-   如需跨实例恢复SQL Server数据库，请确保需要恢复的SQL Server实例版本低于或等于目的SQL Server实例版本。
-   恢复master数据库前，确保SQL Server实例在单用户模式下运行。详情请参见[还原master数据库](https://docs.microsoft.com/zh-cn/sql/relational-databases/backup-restore/restore-the-master-database-transact-sql?view=sql-server-2017)。

## 同地域下的同实例恢复

将备份的数据库恢复到相同地域下的当前SQL Server实例的操作步骤如下：

1.  登录[混合云备份管理控制台](https://hbr.console.aliyun.com)。

2.  在左侧导航栏，选择**备份** \> **ECS应用备份** \> **SQL Server**。

3.  单击**SQL Server实例**页签。

4.  找到需要恢复的SQL Server实例，在其右侧的操作列表中，单击**恢复**。

5.  在弹出的新建恢复计划页面，选择需要恢复的数据库所在的SQL Server实例，然后单击**下一步**。

6.  选中一个需要恢复的数据库，单击**下一步**。

7.  在恢复规则页面，按如下说明填写各项参数，然后单击**下一步**。

    |参数|描述|
    |:-|:-|
    |**目的数据库名**|恢复数据库到目的SQL Server实例中后此数据库的名字。 **说明：**

    -   如果您希望恢复的数据库覆盖现有数据库，输入现有数据库的名字，然后选中**如果目标数据库已存在，则强制覆盖**。
    -   如果您希望恢复的数据库不影响其他现有数据库，输入的数据库名字不可以与现有数据库重复。 |
    |**恢复方式**|    -   最近时间

将数据库恢复到已备份的最近可用状态。

    -   指定时间

将数据库恢复到指定的时间点，系统会将数据库恢复到离这个时间最近的状态。选择此项后，您还需选择一个时间点。

    -   指定备份

将数据库恢复到指定的数据库备份版本。选择此项后，您还需选择一个需要恢复的备份版本。 |

8.  确认源SQL Server实例、源数据库名、目的SQL Server实例、目的数据库名以及恢复规则等配置信息无误后，单击**创建**。


## 同地域下的跨实例恢复

将备份的数据库恢复到相同地域且同仓库下的其他SQL Server实例的操作步骤与同实例恢复类似，区别仅在于您需要选择不同于待恢复的SQL Server实例作为源实例进行恢复。

![SQL Server](https://static-aliyun-doc.oss-cn-hangzhou.aliyuncs.com/assets/img/zh-CN/5827909951/p110639.jpg)

跨实例恢复的其他步骤，请参见[同地域下的同实例恢复](#section_ysg_4dk_dhb)。

## 跨地域下的跨实例恢复

备份库是混合云备份的云上存储仓库，用于保存备份的数据。您可以根据备份容灾的需要，使用异地镜像备份库实现跨地域恢复SQL Server数据库。

使用异地镜像备份库实现跨地域恢复SQL Server数据库前，您需要有已创建的镜像备份库。有关创建镜像备份库的详情，请参见[使用镜像备份库实现跨地域备份](/cn.zh-CN/异地备份/使用镜像备份库实现跨地域备份.md)。

将备份的数据库恢复到其他地域下的SQL Server实例的操作步骤如下：

1.  在左侧导航栏，单击**备份** \> **ECS应用备份** \> **SQL Server**。

2.  选择镜像备份库所在的地域。

3.  在**SQL Server实例**页签，为指定的SQL Server实例安装备份客户端。

    **说明：** 备份库需选择已创建的镜像备份库，且镜像备份库名称带\[COPY\]字样。其他安装备份客户端参数配置，请参见[t141162.md\#section\_rpa\_ndm\_xhb](/cn.zh-CN/ECS备份教程/SQL Server备份/准备工作.md)。

4.  找到需要恢复的SQL Server实例，在其右侧的操作列表中，单击**恢复**。

    其他操作步骤与[同地域下的跨实例恢复](#section_rwx_60b_9be)类似。


## 更多操作

您可以查看恢复任务的状态，并可以取消正在执行的恢复任务。具体操作如下：

1.  在左侧导航栏，选择**备份** \> **ECS应用备份** \> **SQL Server**。

2.  单击**恢复任务**页签。

3.  在恢复任务列表中查看恢复任务的状态。

4.  如需取消正在进行中的恢复任务，在恢复任务右侧，单击**取消**。


